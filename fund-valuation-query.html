<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>åŸºé‡‘å®æ—¶ä¼°å€¼æŸ¥è¯¢</title>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body {
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", "PingFang SC", "Hiragino Sans GB", "Microsoft YaHei", sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }
        .container {
            max-width: 800px;
            margin: 0 auto;
        }
        h1 {
            text-align: center;
            color: #fff;
            font-size: 28px;
            margin-bottom: 24px;
            text-shadow: 0 2px 4px rgba(0,0,0,0.2);
        }
        .search-box {
            display: flex;
            gap: 10px;
            margin-bottom: 24px;
            background: #fff;
            padding: 16px 20px;
            border-radius: 16px;
            box-shadow: 0 8px 32px rgba(0,0,0,0.15);
        }
        .search-box input {
            flex: 1;
            padding: 12px 16px;
            border: 2px solid #e0e0e0;
            border-radius: 10px;
            font-size: 16px;
            outline: none;
            transition: border-color 0.3s;
        }
        .search-box input:focus { border-color: #667eea; }
        .search-box button {
            padding: 12px 28px;
            background: linear-gradient(135deg, #667eea, #764ba2);
            color: #fff;
            border: none;
            border-radius: 10px;
            font-size: 16px;
            cursor: pointer;
            transition: transform 0.2s, box-shadow 0.2s;
            white-space: nowrap;
        }
        .search-box button:hover {
            transform: translateY(-1px);
            box-shadow: 0 4px 12px rgba(102,126,234,0.5);
        }
        .search-box button:disabled {
            opacity: 0.6;
            cursor: not-allowed;
            transform: none;
        }
        .hot-funds {
            background: #fff;
            padding: 16px 20px;
            border-radius: 16px;
            margin-bottom: 24px;
            box-shadow: 0 8px 32px rgba(0,0,0,0.15);
        }
        .hot-funds h3 {
            font-size: 14px;
            color: #888;
            margin-bottom: 10px;
        }
        .hot-funds .tags {
            display: flex;
            flex-wrap: wrap;
            gap: 8px;
        }
        .hot-funds .tag {
            padding: 6px 14px;
            background: #f5f5ff;
            border: 1px solid #e0e0ff;
            border-radius: 20px;
            font-size: 13px;
            color: #555;
            cursor: pointer;
            transition: all 0.2s;
        }
        .hot-funds .tag:hover {
            background: #667eea;
            color: #fff;
            border-color: #667eea;
        }
        .fund-card {
            background: #fff;
            border-radius: 16px;
            padding: 24px;
            margin-bottom: 16px;
            box-shadow: 0 8px 32px rgba(0,0,0,0.15);
            animation: fadeIn 0.4s ease;
        }
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }
        .fund-header {
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
            margin-bottom: 20px;
            flex-wrap: wrap;
            gap: 8px;
        }
        .fund-name {
            font-size: 20px;
            font-weight: 600;
            color: #333;
        }
        .fund-code {
            font-size: 14px;
            color: #999;
            margin-top: 4px;
        }
        .fund-type {
            padding: 4px 12px;
            border-radius: 20px;
            font-size: 12px;
            background: #f0f0ff;
            color: #667eea;
        }
        .estimate-section {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(180px, 1fr));
            gap: 16px;
            margin-bottom: 20px;
        }
        .estimate-item {
            background: #fafafa;
            border-radius: 12px;
            padding: 16px;
            text-align: center;
        }
        .estimate-item .label {
            font-size: 13px;
            color: #999;
            margin-bottom: 8px;
        }
        .estimate-item .value {
            font-size: 24px;
            font-weight: 700;
        }
        .estimate-item .sub {
            font-size: 12px;
            color: #999;
            margin-top: 4px;
        }
        .up { color: #e74c3c; }
        .down { color: #27ae60; }
        .flat { color: #999; }
        .info-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 12px;
        }
        .info-item {
            display: flex;
            justify-content: space-between;
            padding: 8px 12px;
            background: #fafafa;
            border-radius: 8px;
            font-size: 14px;
        }
        .info-item .k { color: #999; }
        .info-item .v { color: #333; font-weight: 500; }
        .loading {
            text-align: center;
            padding: 40px;
            color: #999;
            font-size: 16px;
        }
        .loading .spinner {
            width: 40px;
            height: 40px;
            border: 4px solid #e0e0e0;
            border-top: 4px solid #667eea;
            border-radius: 50%;
            animation: spin 0.8s linear infinite;
            margin: 0 auto 16px;
        }
        @keyframes spin { to { transform: rotate(360deg); } }
        .error-msg {
            text-align: center;
            padding: 24px;
            color: #e74c3c;
            background: #fff5f5;
            border-radius: 12px;
            margin-bottom: 16px;
        }
        .refresh-bar {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 12px;
            font-size: 13px;
            color: rgba(255,255,255,0.7);
        }
        .refresh-bar label {
            display: flex;
            align-items: center;
            gap: 6px;
            cursor: pointer;
        }
        .refresh-bar input[type="checkbox"] {
            accent-color: #667eea;
        }
        .history-section {
            margin-top: 20px;
            padding-top: 16px;
            border-top: 1px solid #eee;
        }
        .history-section h4 {
            font-size: 14px;
            color: #888;
            margin-bottom: 10px;
        }
        .history-table {
            width: 100%;
            border-collapse: collapse;
            font-size: 13px;
        }
        .history-table th {
            text-align: left;
            padding: 8px;
            background: #f8f8f8;
            color: #888;
            font-weight: 500;
            border-radius: 4px;
        }
        .history-table td {
            padding: 8px;
            border-bottom: 1px solid #f0f0f0;
            color: #555;
        }
        .delete-btn {
            background: none;
            border: none;
            color: #ccc;
            cursor: pointer;
            font-size: 16px;
            padding: 2px 6px;
            border-radius: 4px;
            transition: all 0.2s;
        }
        .delete-btn:hover { color: #e74c3c; background: #fff0f0; }
        .disclaimer {
            text-align: center;
            color: rgba(255,255,255,0.5);
            font-size: 12px;
            margin-top: 24px;
            line-height: 1.6;
        }
        .watchlist-section {
            background: #fff;
            border-radius: 16px;
            padding: 20px;
            margin-bottom: 24px;
            box-shadow: 0 8px 32px rgba(0,0,0,0.15);
        }
        .watchlist-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 14px;
            flex-wrap: wrap;
            gap: 10px;
        }
        .watchlist-header h3 {
            font-size: 16px;
            color: #333;
        }
        .watchlist-controls {
            display: flex;
            align-items: center;
            gap: 10px;
            flex-wrap: wrap;
        }
        .watchlist-controls label {
            font-size: 13px;
            color: #666;
            display: flex;
            align-items: center;
            gap: 4px;
        }
        .watchlist-controls select,
        .watchlist-controls input[type="number"] {
            padding: 4px 8px;
            border: 1px solid #ddd;
            border-radius: 6px;
            font-size: 13px;
            outline: none;
            width: 80px;
        }
        .watchlist-controls select:focus,
        .watchlist-controls input[type="number"]:focus {
            border-color: #667eea;
        }
        .watchlist-refresh-btn {
            padding: 5px 14px;
            background: linear-gradient(135deg, #667eea, #764ba2);
            color: #fff;
            border: none;
            border-radius: 6px;
            font-size: 13px;
            cursor: pointer;
            transition: transform 0.2s;
        }
        .watchlist-refresh-btn:hover {
            transform: translateY(-1px);
        }
        .watchlist-refresh-btn:disabled {
            opacity: 0.6;
            cursor: not-allowed;
            transform: none;
        }
        .add-watchlist-bar {
            display: flex;
            align-items: center;
            gap: 10px;
            margin-top: 16px;
            padding-top: 16px;
            border-top: 1px solid #eee;
        }
        .add-watchlist-btn {
            display: flex;
            align-items: center;
            gap: 6px;
            padding: 10px 22px;
            border: 2px solid #f1c40f;
            background: #fffef5;
            color: #d4a800;
            border-radius: 10px;
            font-size: 15px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s;
        }
        .add-watchlist-btn:hover {
            background: #f1c40f;
            color: #fff;
            transform: translateY(-1px);
            box-shadow: 0 4px 12px rgba(241,196,15,0.4);
        }
        .add-watchlist-btn.in-watchlist {
            border-color: #e74c3c;
            background: #fff5f5;
            color: #e74c3c;
        }
        .add-watchlist-btn.in-watchlist:hover {
            background: #e74c3c;
            color: #fff;
            box-shadow: 0 4px 12px rgba(231,76,60,0.4);
        }
        .watchlist-table {
            width: 100%;
            border-collapse: collapse;
            font-size: 13px;
        }
        .watchlist-table th {
            text-align: left;
            padding: 10px 8px;
            background: #f8f8f8;
            color: #888;
            font-weight: 500;
            white-space: nowrap;
        }
        .watchlist-table td {
            padding: 10px 8px;
            border-bottom: 1px solid #f0f0f0;
            color: #555;
        }
        .watchlist-table tr:hover {
            background: #fafaff;
        }
        .watchlist-table td.up { color: #e74c3c; }
        .watchlist-table td.down { color: #27ae60; }
        .history-table td.up { color: #e74c3c; }
        .history-table td.down { color: #27ae60; }
        .watchlist-empty {
            text-align: center;
            padding: 30px;
            color: #ccc;
            font-size: 14px;
        }
        .watchlist-remove-btn {
            background: none;
            border: none;
            color: #ccc;
            cursor: pointer;
            font-size: 16px;
            padding: 2px 6px;
            border-radius: 4px;
            transition: all 0.2s;
        }
        .watchlist-remove-btn:hover {
            color: #e74c3c;
            background: #fff0f0;
        }

        .watchlist-countdown {
            font-size: 12px;
            color: #999;
            margin-left: 6px;
        }
        @media (max-width: 600px) {
            h1 { font-size: 22px; }
            .estimate-item .value { font-size: 20px; }
            .watchlist-controls { flex-direction: column; align-items: flex-start; }
        }
        .holdings-table {
            width: 100%;
            border-collapse: collapse;
            font-size: 13px;
        }
        .holdings-table th {
            background: #f8f9fa;
            padding: 8px 6px;
            text-align: left;
            font-weight: 600;
            color: #555;
            border-bottom: 2px solid #eee;
            white-space: nowrap;
        }
        .holdings-table td {
            padding: 7px 6px;
            border-bottom: 1px solid #f0f0f0;
            color: #444;
        }
        .holdings-table tr:hover {
            background: #f8f9fe;
        }
        .holdings-table .pct-bar {
            display: inline-block;
            height: 6px;
            border-radius: 3px;
            background: linear-gradient(90deg, #667eea, #764ba2);
            vertical-align: middle;
            margin-right: 6px;
        }
        .holdings-table td.up { color: #e74c3c; font-weight: 600; }
        .holdings-table td.down { color: #27ae60; font-weight: 600; }
        .holdings-table td.flat { color: #999; }
        .sector-tags {
            display: flex;
            flex-wrap: wrap;
            gap: 6px;
            margin-top: 8px;
        }
        .sector-tag {
            display: inline-block;
            padding: 3px 10px;
            border-radius: 12px;
            font-size: 12px;
            font-weight: 500;
            background: linear-gradient(135deg, #e8f4f8, #d1ecf1);
            color: #0c5460;
            border: 1px solid #bee5eb;
        }
        .sector-tag.cat-stock { background: linear-gradient(135deg, #ffe8e8, #ffd4d4); color: #c0392b; border-color: #f5c6cb; }
        .sector-tag.cat-index { background: linear-gradient(135deg, #e8f0ff, #d4e4ff); color: #2c5aa0; border-color: #b8d4fe; }
        .sector-tag.cat-bond { background: linear-gradient(135deg, #e8ffe8, #d4ffd4); color: #1e7e34; border-color: #c3e6cb; }
        .sector-tag.cat-theme { background: linear-gradient(135deg, #fff3e0, #ffe0b2); color: #e65100; border-color: #ffcc80; }
        .sector-tag.cat-market { background: linear-gradient(135deg, #f3e5f5, #e1bee7); color: #6a1b9a; border-color: #ce93d8; }
        .history-tag-wrapper {
            display: inline-flex;
            align-items: center;
            gap: 2px;
            padding: 6px 8px 6px 14px;
            background: #f5f5ff;
            border: 1px solid #e0e0ff;
            border-radius: 20px;
            font-size: 13px;
            color: #555;
            transition: all 0.2s;
        }
        .history-tag-wrapper:hover {
            background: #eeeeff;
            border-color: #c0c0ff;
        }
        .history-tag-wrapper .tag-text {
            cursor: pointer;
        }
        .history-tag-wrapper .tag-delete {
            display: inline-flex;
            align-items: center;
            justify-content: center;
            width: 18px;
            height: 18px;
            border-radius: 50%;
            background: none;
            border: none;
            color: #ccc;
            cursor: pointer;
            font-size: 14px;
            line-height: 1;
            transition: all 0.2s;
            margin-left: 4px;
        }
        .history-tag-wrapper .tag-delete:hover {
            color: #e74c3c;
            background: #ffe0e0;
        }
        .clear-history-btn {
            padding: 4px 12px;
            background: none;
            border: 1px solid #ddd;
            border-radius: 12px;
            font-size: 12px;
            color: #999;
            cursor: pointer;
            transition: all 0.2s;
        }
        .clear-history-btn:hover {
            color: #e74c3c;
            border-color: #e74c3c;
            background: #fff5f5;
        }
        .watchlist-sector {
            max-width: 120px;
        }
        .watchlist-sector .sector-tag {
            font-size: 11px;
            padding: 2px 7px;
            margin: 1px 0;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>ğŸ“ˆ DeusJåŸºé‡‘å®æ—¶ä¼°å€¼æŸ¥è¯¢</h1>

        <div class="search-box">
            <input type="text" id="fundInput" placeholder="è¾“å…¥åŸºé‡‘ä»£ç ï¼Œå¦‚ 110011ã€005827"
                   onkeydown="if(event.key==='Enter') queryFund()">
            <button id="queryBtn" onclick="queryFund()">æŸ¥è¯¢</button>
        </div>

        <div class="hot-funds">
            <h3>ğŸ”¥ çƒ­é—¨åŸºé‡‘</h3>
            <div class="tags">
                <span class="tag" onclick="quickQuery('110011')">110011 æ˜“æ–¹è¾¾ä¸­å°ç›˜</span>
                <span class="tag" onclick="quickQuery('005827')">005827 æ˜“æ–¹è¾¾è“ç­¹</span>
                <span class="tag" onclick="quickQuery('161725')">161725 æ‹›å•†ä¸­è¯ç™½é…’</span>
                <span class="tag" onclick="quickQuery('003834')">003834 åå¤èƒ½æºé©æ–°</span>
                <span class="tag" onclick="quickQuery('260108')">260108 æ™¯é¡ºé•¿åŸæ–°å…´æˆé•¿</span>
                <span class="tag" onclick="quickQuery('519736')">519736 äº¤é“¶æ–°æˆé•¿</span>
                <span class="tag" onclick="quickQuery('000961')">000961 å¤©å¼˜æ²ªæ·±300ETFè”æ¥</span>
                <span class="tag" onclick="quickQuery('510300')">510300 æ²ªæ·±300ETF</span>
            </div>
        </div>

        <div class="hot-funds" id="historySection" style="display:none;">
            <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:10px;">
                <h3>ğŸ• æœ€è¿‘æŸ¥è¯¢</h3>
                <button class="clear-history-btn" onclick="clearAllHistory()">ğŸ—‘ æ¸…ç©ºå†å²</button>
            </div>
            <div class="tags" id="historyTags"></div>
        </div>

        <div class="refresh-bar">
            <span id="lastUpdate"></span>
        </div>

        <div id="result"></div>

        <!-- è‡ªé€‰åˆ—è¡¨ -->
        <div class="watchlist-section" id="watchlistSection">
            <div class="watchlist-header">
                <h3>â­ è‡ªé€‰åˆ—è¡¨</h3>
            </div>
            <div id="watchlistContent"></div>
        </div>

        <p class="disclaimer">
            âš ï¸ ä¼°å€¼æ•°æ®æ¥æºäºå…¬å¼€æ¥å£ï¼Œä»…ä¾›å‚è€ƒï¼Œä¸æ„æˆæŠ•èµ„å»ºè®®ã€‚<br>
            å®é™…å‡€å€¼ä»¥åŸºé‡‘å…¬å¸æŠ«éœ²ä¸ºå‡†ã€‚æ•°æ®å¯èƒ½å­˜åœ¨å»¶è¿Ÿã€‚<br>
            Â© 2026 jiangzhou Â· <a href="mailto:819809300@qq.com" style="color:rgba(255,255,255,0.5);">819809300@qq.com</a>
        </p>
    </div>

    <script>
        let autoRefreshTimer = null;
        let currentFundCode = '';
        let queryHistory = JSON.parse(localStorage.getItem('fundQueryHistory') || '[]');

        // è‡ªé€‰åˆ—è¡¨ç›¸å…³
        let watchlist = JSON.parse(localStorage.getItem('fundWatchlist') || '[]');
        let watchlistData = {}; // code -> latest data
        let watchlistCountdownTimer = null;

        function quickQuery(code) {
            document.getElementById('fundInput').value = code;
            queryFund();
        }

        function queryFund() {
            const code = document.getElementById('fundInput').value.trim();
            if (!code) {
                showError('è¯·è¾“å…¥åŸºé‡‘ä»£ç ');
                return;
            }
            if (!/^\d{6}$/.test(code)) {
                showError('è¯·è¾“å…¥6ä½æ•°å­—åŸºé‡‘ä»£ç ');
                return;
            }
            currentFundCode = code;
            fetchFundData(code);
        }

        function showError(msg) {
            document.getElementById('result').innerHTML = `<div class="error-msg">âŒ ${msg}</div>`;
        }

        function showLoading() {
            document.getElementById('result').innerHTML = `
                <div class="fund-card">
                    <div class="loading">
                        <div class="spinner"></div>
                        æ­£åœ¨æŸ¥è¯¢åŸºé‡‘æ•°æ®...
                    </div>
                </div>`;
        }

        function fetchFundData(code) {
            const btn = document.getElementById('queryBtn');
            btn.disabled = true;
            btn.textContent = 'æŸ¥è¯¢ä¸­...';
            showLoading();

            enqueueJsonp(code, function(data) {
                btn.disabled = false;
                btn.textContent = 'æŸ¥è¯¢';
                if (data && data.fundcode) {
                    renderFundData(data);
                    saveHistory(data);
                    updateLastTime();
                } else {
                    showError('æœªæ‰¾åˆ°è¯¥åŸºé‡‘ï¼Œè¯·æ£€æŸ¥åŸºé‡‘ä»£ç æ˜¯å¦æ­£ç¡®');
                }
            });
        }

        function closeResult() {
            document.getElementById('result').innerHTML = '';
            currentFundCode = '';
        }

        function renderFundData(data) {
            const gszzl = parseFloat(data.gszzl); // ä¼°ç®—æ¶¨å¹…
            const gsz = parseFloat(data.gsz);     // ä¼°ç®—å‡€å€¼
            const dwjz = parseFloat(data.dwjz);   // å•ä½å‡€å€¼ï¼ˆä¸Šä¸€æ—¥ï¼‰

            const colorClass = gszzl > 0 ? 'up' : gszzl < 0 ? 'down' : 'flat';
            const arrow = gszzl > 0 ? 'â–²' : gszzl < 0 ? 'â–¼' : 'â€”';
            const sign = gszzl > 0 ? '+' : '';

            // Calculate estimated change amount
            const changeAmount = (gsz - dwjz).toFixed(4);
            const changeSign = changeAmount >= 0 ? '+' : '';

            const isInWatchlist = watchlist.some(w => w.code === data.fundcode);
            const wlBtnClass = isInWatchlist ? 'add-watchlist-btn in-watchlist' : 'add-watchlist-btn';
            const wlBtnText = isInWatchlist ? 'â˜… å·²åœ¨è‡ªé€‰ (ç‚¹å‡»ç§»é™¤)' : 'â˜† åŠ å…¥è‡ªé€‰åˆ—è¡¨';

            const html = `
                <div class="fund-card">
                    <div class="fund-header">
                        <div>
                            <div class="fund-name">${data.name || 'æœªçŸ¥åŸºé‡‘'}</div>
                            <div class="fund-code">åŸºé‡‘ä»£ç ï¼š${data.fundcode}</div>
                        </div>
                        <div style="display:flex; align-items:center; gap:10px;">
                            <span class="fund-type">${getFundType(data.fundcode)}</span>
                            <button onclick="closeResult()" title="å…³é—­" style="background:none;border:none;font-size:20px;color:#ccc;cursor:pointer;padding:2px 6px;border-radius:50%;transition:all 0.2s;" onmouseover="this.style.color='#e74c3c';this.style.background='#fff0f0'" onmouseout="this.style.color='#ccc';this.style.background='none'">âœ•</button>
                        </div>
                    </div>

                    <div id="fundSectors" class="sector-tags" style="margin-bottom:16px;"></div>

                    <div class="estimate-section">
                        <div class="estimate-item">
                            <div class="label">å®æ—¶ä¼°å€¼</div>
                            <div class="value ${colorClass}">${gsz.toFixed(4)}</div>
                            <div class="sub">ä¼°ç®—å‡€å€¼</div>
                        </div>
                        <div class="estimate-item">
                            <div class="label">ä¼°ç®—æ¶¨å¹…</div>
                            <div class="value ${colorClass}">${arrow} ${sign}${gszzl.toFixed(2)}%</div>
                            <div class="sub">${changeSign}${changeAmount}</div>
                        </div>
                    </div>

                    <div class="info-grid">
                        <div class="info-item">
                            <span class="k">å‡€å€¼æ—¥æœŸ</span>
                            <span class="v">${data.jzrq || '--'}</span>
                        </div>
                        <div class="info-item">
                            <span class="k">ä¼°å€¼æ—¶é—´</span>
                            <span class="v">${data.gztime || '--'}</span>
                        </div>
                        <div class="info-item">
                            <span class="k">ä¼°å€¼å˜åŠ¨</span>
                            <span class="v ${colorClass}">${changeSign}${changeAmount}</span>
                        </div>
                        <div class="info-item">
                            <span class="k">æ•°æ®æ¥æº</span>
                            <span class="v">å¤©å¤©åŸºé‡‘</span>
                        </div>
                        <div class="info-item">
                            <span class="k">çœŸå®å‡€å€¼</span>
                            <span class="v" style="color:#333">${dwjz.toFixed(4)} <small style="color:#aaa">(ğŸ“…${data.jzrq || '--'})</small></span>
                        </div>
                        <div class="info-item">
                            <span class="k">çœŸå®æ¶¨å¹…</span>
                            <span class="v flat" id="realChangeValue">åŠ è½½ä¸­...</span>
                        </div>
                    </div>

                    ${renderInvestCalc(gsz, gszzl, dwjz)}

                    <div id="realNavInfo" style="margin-top:16px; padding-top:16px; border-top:1px solid #eee;">
                        <div style="text-align:center; color:#ccc; padding:10px; font-size:13px;">æ­£åœ¨è·å–çœŸå®å‡€å€¼æ•°æ®...</div>
                    </div>

                    <div id="holdingsInfo" style="margin-top:16px; padding-top:16px; border-top:1px solid #eee;">
                        <div style="text-align:center; color:#ccc; padding:10px; font-size:13px;">æ­£åœ¨è·å–æŒä»“ä¿¡æ¯...</div>
                    </div>

                    <div class="add-watchlist-bar">
                        <button class="${wlBtnClass}" onclick="toggleWatchlistFromCard('${data.fundcode}','${(data.name || '').replace(/'/g, "\\'")}')"
                                id="watchlistToggleBtn">
                            ${wlBtnText}
                        </button>
                        <span style="font-size:13px; color:#aaa;">${isInWatchlist ? 'è¯¥åŸºé‡‘å·²åœ¨ä½ çš„è‡ªé€‰åˆ—è¡¨ä¸­' : 'æ·»åŠ åå¯åœ¨è‡ªé€‰åˆ—è¡¨è‡ªåŠ¨åˆ·æ–°ä¼°å€¼'}</span>
                    </div>
                </div>
            `;

            document.getElementById('result').innerHTML = html;
            renderHistoryTags();
            renderFundSectors(data.fundcode, data.name);
            fetchRealNav(data.fundcode, function() {
                fetchFundHoldings(data.fundcode);
            });
        }

        function renderInvestCalc(gsz, gszzl, dwjz) {
            return `
                <div class="history-section">
                    <h4>ğŸ’° æ”¶ç›Šä¼°ç®—å™¨</h4>
                    <div style="display:flex; gap:10px; align-items:center; margin-top:8px; flex-wrap:wrap;">
                        <span style="font-size:14px; color:#888;">æŒæœ‰ä»½é¢ï¼š</span>
                        <input type="number" id="shareInput" placeholder="è¾“å…¥ä»½é¢"
                               style="padding:8px 12px; border:2px solid #e0e0e0; border-radius:8px; font-size:14px; width:140px; outline:none;"
                               oninput="calcProfit(${gsz}, ${gszzl}, ${dwjz})">
                        <span style="font-size:14px; color:#888;">æˆ–æŒæœ‰é‡‘é¢ï¼š</span>
                        <input type="number" id="amountInput" placeholder="è¾“å…¥é‡‘é¢(å…ƒ)"
                               style="padding:8px 12px; border:2px solid #e0e0e0; border-radius:8px; font-size:14px; width:140px; outline:none;"
                               oninput="calcProfitByAmount(${gsz}, ${gszzl}, ${dwjz})">
                    </div>
                    <div id="profitResult" style="margin-top:12px; font-size:14px; color:#666;"></div>
                </div>
            `;
        }

        function calcProfit(gsz, gszzl, dwjz) {
            const shares = parseFloat(document.getElementById('shareInput').value);
            if (!shares || shares <= 0) {
                document.getElementById('profitResult').innerHTML = '';
                return;
            }
            const totalValue = (shares * gsz).toFixed(2);
            const yesterdayValue = (shares * dwjz).toFixed(2);
            const todayProfit = (totalValue - yesterdayValue).toFixed(2);
            const sign = todayProfit >= 0 ? '+' : '';
            const cls = todayProfit >= 0 ? 'up' : 'down';

            document.getElementById('profitResult').innerHTML = `
                <div style="display:grid; grid-template-columns:repeat(auto-fit, minmax(160px,1fr)); gap:8px;">
                    <div class="info-item"><span class="k">ä¼°ç®—æ€»å¸‚å€¼</span><span class="v">Â¥${formatNum(totalValue)}</span></div>
                    <div class="info-item"><span class="k">æ˜¨æ—¥æ€»å¸‚å€¼</span><span class="v">Â¥${formatNum(yesterdayValue)}</span></div>
                    <div class="info-item"><span class="k">ä»Šæ—¥ä¼°ç®—æ”¶ç›Š</span><span class="v ${cls}">${sign}Â¥${formatNum(todayProfit)}</span></div>
                </div>
            `;
        }

        function calcProfitByAmount(gsz, gszzl, dwjz) {
            const amount = parseFloat(document.getElementById('amountInput').value);
            if (!amount || amount <= 0) {
                document.getElementById('profitResult').innerHTML = '';
                return;
            }
            const shares = amount / dwjz;
            const totalValue = (shares * gsz).toFixed(2);
            const todayProfit = (totalValue - amount).toFixed(2);
            const sign = todayProfit >= 0 ? '+' : '';
            const cls = todayProfit >= 0 ? 'up' : 'down';

            document.getElementById('profitResult').innerHTML = `
                <div style="display:grid; grid-template-columns:repeat(auto-fit, minmax(160px,1fr)); gap:8px;">
                    <div class="info-item"><span class="k">æŒæœ‰ä»½é¢</span><span class="v">${shares.toFixed(2)}ä»½</span></div>
                    <div class="info-item"><span class="k">ä¼°ç®—æ€»å¸‚å€¼</span><span class="v">Â¥${formatNum(totalValue)}</span></div>
                    <div class="info-item"><span class="k">ä»Šæ—¥ä¼°ç®—æ”¶ç›Š</span><span class="v ${cls}">${sign}Â¥${formatNum(todayProfit)}</span></div>
                </div>
            `;
        }

        function formatNum(n) {
            return parseFloat(n).toLocaleString('zh-CN', { minimumFractionDigits: 2, maximumFractionDigits: 2 });
        }

        function getFundType(code) {
            const prefix = code.substring(0, 2);
            const typeMap = {
                '51': 'ETFåŸºé‡‘', '15': 'ETFåŸºé‡‘', '16': 'LOFåŸºé‡‘',
                '50': 'å°é—­åŸºé‡‘', '18': 'å°é—­åŸºé‡‘'
            };
            return typeMap[prefix] || 'å¼€æ”¾å¼åŸºé‡‘';
        }

        function saveHistory(data) {
            const exists = queryHistory.findIndex(h => h.code === data.fundcode);
            if (exists !== -1) queryHistory.splice(exists, 1);
            queryHistory.unshift({
                code: data.fundcode,
                name: data.name,
                gsz: data.gsz,
                gszzl: data.gszzl,
                time: new Date().toLocaleString('zh-CN')
            });
            if (queryHistory.length > 10) queryHistory.pop();
            localStorage.setItem('fundQueryHistory', JSON.stringify(queryHistory));
        }

        function renderHistoryTags() {
            const section = document.getElementById('historySection');
            const container = document.getElementById('historyTags');
            if (queryHistory.length === 0) {
                section.style.display = 'none';
                return;
            }
            section.style.display = '';
            container.innerHTML = queryHistory.map(function(h) {
                const gszzl = parseFloat(h.gszzl);
                const cls = gszzl > 0 ? 'up' : gszzl < 0 ? 'down' : 'flat';
                const sign = gszzl > 0 ? '+' : '';
                return `<span class="history-tag-wrapper">
                    <span class="tag-text" onclick="quickQuery('${h.code}')">${h.code} ${h.name} <small class="${cls}" style="font-weight:600;">${sign}${gszzl.toFixed(2)}%</small></span>
                    <button class="tag-delete" onclick="event.stopPropagation(); deleteHistoryItem('${h.code}')" title="åˆ é™¤">Ã—</button>
                </span>`;
            }).join('');
        }

        function deleteHistoryItem(code) {
            queryHistory = queryHistory.filter(function(h) { return h.code !== code; });
            localStorage.setItem('fundQueryHistory', JSON.stringify(queryHistory));
            renderHistoryTags();
        }

        function clearAllHistory() {
            if (queryHistory.length === 0) return;
            queryHistory = [];
            localStorage.setItem('fundQueryHistory', JSON.stringify(queryHistory));
            renderHistoryTags();
        }

        function parseRealNavData(content) {
            const parser = new DOMParser();
            const doc = parser.parseFromString(content, 'text/html');
            const rows = doc.querySelectorAll('tbody tr');
            const records = [];
            rows.forEach(function(row) {
                const tds = row.querySelectorAll('td');
                if (tds.length >= 4) {
                    records.push({
                        date: tds[0].textContent.trim(),
                        nav: tds[1].textContent.trim(),
                        accNav: tds[2].textContent.trim(),
                        change: tds[3].textContent.trim()
                    });
                }
            });
            return records;
        }

        function fetchRealNav(code, callback) {
            const script = document.createElement('script');
            let handled = false;

            function finish(records) {
                if (callback) callback(records);
            }

            script.onload = function() {
                if (handled) return;
                handled = true;
                if (script.parentNode) script.parentNode.removeChild(script);
                try {
                    if (window.apidata && window.apidata.content) {
                        const records = parseRealNavData(window.apidata.content);
                        window.apidata = undefined;

                        // Update real change in estimate section
                        const realChangeValue = document.getElementById('realChangeValue');
                        if (realChangeValue && records.length > 0) {
                            const latest = records[0];
                            const changeVal = parseFloat(latest.change);
                            const cls = changeVal > 0 ? 'up' : changeVal < 0 ? 'down' : 'flat';
                            const changeSign = changeVal > 0 ? '+' : '';
                            const changeText = isNaN(changeVal) ? latest.change : `${changeSign}${changeVal.toFixed(2)}%`;
                            realChangeValue.className = `v ${cls}`;
                            realChangeValue.innerHTML = `${changeText} <small style="color:#aaa;">(ğŸ“…${latest.date})</small>`;
                        } else if (realChangeValue) {
                            realChangeValue.className = 'v flat';
                            realChangeValue.textContent = '--';
                        }

                        // Render history table
                        let navHtml = '';
                        records.forEach(function(r) {
                            const changeVal = parseFloat(r.change);
                            const cls = changeVal > 0 ? 'up' : changeVal < 0 ? 'down' : 'flat';
                            navHtml += `<tr>
                                <td>${r.date}</td>
                                <td style="font-weight:600;">${r.nav}</td>
                                <td>${r.accNav}</td>
                                <td class="${cls}">${r.change}</td>
                            </tr>`;
                        });
                        const el = document.getElementById('realNavInfo');
                        if (el && navHtml) {
                            el.innerHTML = `
                                <h4 style="font-size:14px; color:#888; margin-bottom:10px;">ğŸ“Š çœŸå®å‡€å€¼ï¼ˆæœ€è¿‘å·²å…¬å¸ƒï¼‰</h4>
                                <div style="overflow-x:auto;">
                                    <table class="history-table">
                                        <thead><tr><th>æ—¥æœŸ</th><th>å•ä½å‡€å€¼</th><th>ç´¯è®¡å‡€å€¼</th><th>æ—¥æ¶¨å¹…</th></tr></thead>
                                        <tbody>${navHtml}</tbody>
                                    </table>
                                </div>`;
                        } else if (el) {
                            el.innerHTML = '';
                        }
                        finish(records);
                    } else {
                        finish([]);
                    }
                } catch(e) {
                    const el = document.getElementById('realNavInfo');
                    if (el) el.innerHTML = '';
                    finish([]);
                }
            };

            script.onerror = function() {
                if (handled) return;
                handled = true;
                if (script.parentNode) script.parentNode.removeChild(script);
                const el = document.getElementById('realNavInfo');
                if (el) el.innerHTML = '<div style="text-align:center; color:#ccc; padding:10px; font-size:13px;">çœŸå®å‡€å€¼æ•°æ®æš‚æ—¶æ— æ³•è·å–</div>';
                const realChangeValue = document.getElementById('realChangeValue');
                if (realChangeValue) {
                    realChangeValue.className = 'v flat';
                    realChangeValue.textContent = '--';
                }
                finish([]);
            };

            script.src = `https://fund.eastmoney.com/f10/F10DataApi.aspx?type=lsjz&code=${code}&page=1&per=5`;
            document.head.appendChild(script);

            setTimeout(function() {
                if (!handled) {
                    handled = true;
                    if (script.parentNode) script.parentNode.removeChild(script);
                    finish([]);
                }
            }, 8000);
        }

        // Fetch real nav for a watchlist item (no DOM update for card, just returns data)
        function fetchRealNavForWatchlist(code, callback) {
            const script = document.createElement('script');
            let handled = false;

            script.onload = function() {
                if (handled) return;
                handled = true;
                if (script.parentNode) script.parentNode.removeChild(script);
                try {
                    if (window.apidata && window.apidata.content) {
                        const records = parseRealNavData(window.apidata.content);
                        window.apidata = undefined;
                        callback(records);
                    } else {
                        callback([]);
                    }
                } catch(e) {
                    callback([]);
                }
            };

            script.onerror = function() {
                if (handled) return;
                handled = true;
                if (script.parentNode) script.parentNode.removeChild(script);
                callback([]);
            };

            script.src = `https://fund.eastmoney.com/f10/F10DataApi.aspx?type=lsjz&code=${code}&page=1&per=2`;
            document.head.appendChild(script);

            setTimeout(function() {
                if (!handled) {
                    handled = true;
                    if (script.parentNode) script.parentNode.removeChild(script);
                    callback([]);
                }
            }, 8000);
        }

        function fetchFundHoldings(code) {
            const el = document.getElementById('holdingsInfo');
            if (!el) return;

            const script = document.createElement('script');
            let handled = false;

            script.onload = function() {
                if (handled) return;
                handled = true;
                if (script.parentNode) script.parentNode.removeChild(script);
                try {
                    if (window.apidata && window.apidata.content) {
                        const htmlStr = window.apidata.content;
                        window.apidata = undefined;
                        const parser = new DOMParser();
                        const doc = parser.parseFromString(htmlStr, 'text/html');
                        const tables = doc.querySelectorAll('table');
                        if (tables.length === 0) {
                            el.innerHTML = '';
                            return;
                        }
                        const table = tables[0];
                        const rows = table.querySelectorAll('tbody tr');
                        if (rows.length === 0) {
                            el.innerHTML = '';
                            return;
                        }

                        let holdings = [];
                        rows.forEach(function(row) {
                            const tds = row.querySelectorAll('td');
                            if (tds.length >= 9) {
                                holdings.push({
                                    index: (tds[0].textContent || '').trim(),
                                    code: (tds[1].textContent || '').trim(),
                                    name: (tds[2].textContent || '').trim(),
                                    pct: (tds[6].textContent || '').trim(),
                                    shares: (tds[7].textContent || '').trim(),
                                    value: (tds[8].textContent || '').trim()
                                });
                            }
                        });

                        if (holdings.length === 0) {
                            el.innerHTML = '';
                            return;
                        }

                        const periodLabel = doc.querySelector('.right label') || doc.querySelector('label');
                        let periodText = '';
                        if (periodLabel) {
                            periodText = (periodLabel.textContent || '').trim();
                        }
                        const labFont = doc.querySelector('font.px12');
                        if (!periodText && labFont) {
                            periodText = (labFont.textContent || '').trim();
                        }

                        let holdingsRows = holdings.map(function(h) {
                            const pctVal = parseFloat(h.pct);
                            const barWidth = isNaN(pctVal) ? 0 : Math.min(pctVal * 8, 100);
                            return `<tr>
                                <td>${h.index}</td>
                                <td style="font-weight:600; color:#667eea;">${h.code}</td>
                                <td>${h.name}</td>
                                <td><span class="pct-bar" style="width:${barWidth}px;"></span>${h.pct}</td>
                                <td>${h.shares}\u4e07\u80a1</td>
                                <td>${h.value}\u4e07\u5143</td>
                                <td class="flat" id="stk-chg-${h.code}">--</td>
                            </tr>`;
                        }).join('');

                        el.innerHTML = `
                            <h4 style="font-size:14px; color:#888; margin-bottom:10px;">
                                \ud83c\udfe6 \u524d\u5341\u5927\u6301\u4ed3${periodText ? ' <small style="color:#bbb;">(' + periodText + ')</small>' : ''}
                            </h4>
                            <div style="overflow-x:auto;">
                                <table class="holdings-table">
                                    <thead><tr><th>#</th><th>\u80a1\u7968\u4ee3\u7801</th><th>\u80a1\u7968\u540d\u79f0</th><th>\u5360\u51c0\u503c\u6bd4</th><th>\u6301\u80a1\u6570</th><th>\u6301\u4ed3\u5e02\u503c</th><th>\u5b9e\u65f6\u6da8\u5e45</th></tr></thead>
                                    <tbody>${holdingsRows}</tbody>
                                </table>
                            </div>`;

                        fetchStockQuotes(holdings.map(function(h) { return h.code; }));
                    } else {
                        window.apidata = undefined;
                        el.innerHTML = '';
                    }
                } catch(e) {
                    el.innerHTML = '';
                }
            };

            script.onerror = function() {
                if (handled) return;
                handled = true;
                if (script.parentNode) script.parentNode.removeChild(script);
                el.innerHTML = '<div style="text-align:center; color:#ccc; padding:10px; font-size:13px;">\u6301\u4ed3\u4fe1\u606f\u6682\u65f6\u65e0\u6cd5\u83b7\u53d6</div>';
            };

            script.src = `https://fundf10.eastmoney.com/FundArchivesDatas.aspx?type=jjcc&code=${code}&topline=10&year=&month=&rt=${Math.random()}`;
            document.head.appendChild(script);

            setTimeout(function() {
                if (!handled) {
                    handled = true;
                    if (script.parentNode) script.parentNode.removeChild(script);
                    el.innerHTML = '';
                }
            }, 10000);
        }

        function getSecId(stockCode) {
            if (stockCode.length === 5) {
                return '116.' + stockCode;
            }
            if (stockCode.startsWith('6')) {
                return '1.' + stockCode;
            }
            return '0.' + stockCode;
        }

        function fetchStockQuotes(codes) {
            if (!codes || codes.length === 0) return;
            const secids = codes.map(getSecId).join(',');
            const cbName = 'stockQuoteCb_' + Date.now();
            const script = document.createElement('script');
            let handled = false;

            window[cbName] = function(resp) {
                handled = true;
                if (script.parentNode) script.parentNode.removeChild(script);
                try {
                    if (resp && resp.data && resp.data.diff) {
                        resp.data.diff.forEach(function(item) {
                            const code = item.f12;
                            const change = item.f3;
                            const price = item.f2;
                            const el = document.getElementById('stk-chg-' + code);
                            if (!el) return;
                            if (change === '-' || change === undefined || change === null) {
                                el.textContent = 'åœç‰Œ';
                                el.className = 'flat';
                                return;
                            }
                            const val = parseFloat(change);
                            const cls = val > 0 ? 'up' : val < 0 ? 'down' : 'flat';
                            const sign = val > 0 ? '+' : '';
                            const priceText = (price !== '-' && price !== undefined) ? parseFloat(price).toFixed(2) : '';
                            el.className = cls;
                            el.innerHTML = `${sign}${val.toFixed(2)}%${priceText ? '<br><small style=\"color:#aaa;font-weight:normal;\">Â¥' + priceText + '</small>' : ''}`;
                        });
                    }
                } catch(e) {}
                delete window[cbName];
            };

            script.onerror = function() {
                if (handled) return;
                handled = true;
                if (script.parentNode) script.parentNode.removeChild(script);
                delete window[cbName];
            };

            script.src = `https://push2.eastmoney.com/api/qt/ulist.np/get?cb=${cbName}&fltt=2&fields=f2,f3,f12,f14&secids=${secids}`;
            document.head.appendChild(script);

            setTimeout(function() {
                if (!handled) {
                    handled = true;
                    if (script.parentNode) script.parentNode.removeChild(script);
                    delete window[cbName];
                }
            }, 10000);
        }

        function updateLastTime() {
            document.getElementById('lastUpdate').textContent =
                'æœ€åæ›´æ–°ï¼š' + new Date().toLocaleTimeString('zh-CN');
        }

        // ============ è‡ªé€‰åˆ—è¡¨åŠŸèƒ½ ============

        function saveWatchlist() {
            localStorage.setItem('fundWatchlist', JSON.stringify(watchlist));
        }

        function addToWatchlist(code, name) {
            if (!code) return;
            if (watchlist.some(w => w.code === code)) return;
            watchlist.push({ code, name: name || 'æœªçŸ¥åŸºé‡‘' });
            saveWatchlist();
            refreshAllWatchlist();
        }

        function removeFromWatchlist(code) {
            watchlist = watchlist.filter(w => w.code !== code);
            delete watchlistData[code];
            saveWatchlist();
            renderWatchlist();
            // Refresh current card if it's showing this fund (to update star)
            if (currentFundCode === code) {
                fetchFundData(code);
            }
        }

        function toggleWatchlistFromCard(code, name) {
            const exists = watchlist.some(w => w.code === code);
            if (exists) {
                removeFromWatchlist(code);
            } else {
                watchlist.push({ code, name });
                saveWatchlist();
                refreshAllWatchlist();
            }
            // Re-render current card to update star
            if (currentFundCode === code) {
                fetchFundData(code);
            }
        }

        let jsonpQueue = [];
        let jsonpBusy = false;

        function enqueueJsonp(code, callback) {
            jsonpQueue.push({ code, callback });
            processJsonpQueue();
        }

        function processJsonpQueue() {
            if (jsonpBusy || jsonpQueue.length === 0) return;
            jsonpBusy = true;
            const { code, callback } = jsonpQueue.shift();

            const script = document.createElement('script');
            let handled = false;

            function done(data) {
                if (handled) return;
                handled = true;
                if (script.parentNode) script.parentNode.removeChild(script);
                jsonpBusy = false;
                callback(data);
                processJsonpQueue();
            }

            window.jsonpgz = function(data) { done(data); };

            script.onerror = function() { done(null); };

            script.src = `https://fundgz.1234567.com.cn/js/${code}.js?rt=${Date.now()}`;
            document.head.appendChild(script);

            setTimeout(function() { done(null); }, 8000);
        }

        let watchlistRealNav = {}; // code -> { change, date }
        let fundSectorCache = {}; // code -> [sector1, sector2, ...]

        const sectorKeywordMap = {
            'ç™½é…’': 'ç™½é…’', 'æ¶ˆè´¹': 'æ¶ˆè´¹', 'åŒ»è¯': 'åŒ»è¯', 'åŒ»ç–—': 'åŒ»è¯',
            'ç§‘æŠ€': 'ç§‘æŠ€', 'åŠå¯¼ä½“': 'åŠå¯¼ä½“', 'èŠ¯ç‰‡': 'åŠå¯¼ä½“', 'æ–°èƒ½æº': 'æ–°èƒ½æº',
            'å…‰ä¼': 'å…‰ä¼', 'å†›å·¥': 'å†›å·¥', 'å›½é˜²': 'å†›å·¥', 'é“¶è¡Œ': 'é“¶è¡Œ',
            'é‡‘è': 'é‡‘è', 'åœ°äº§': 'åœ°äº§', 'æˆ¿åœ°äº§': 'åœ°äº§', 'è¯åˆ¸': 'è¯åˆ¸',
            'é’¢é“': 'é’¢é“', 'ç…¤ç‚­': 'ç…¤ç‚­', 'æœ‰è‰²': 'æœ‰è‰²é‡‘å±', 'å†œä¸š': 'å†œä¸š',
            'é£Ÿå“': 'é£Ÿå“é¥®æ–™', 'é¥®æ–™': 'é£Ÿå“é¥®æ–™', 'æ±½è½¦': 'æ±½è½¦', 'ç”µåŠ›': 'ç”µåŠ›',
            'ä¼ åª’': 'ä¼ åª’', 'äº’è”ç½‘': 'äº’è”ç½‘', 'è®¡ç®—æœº': 'è®¡ç®—æœº', 'é€šä¿¡': 'é€šä¿¡',
            'ç¯ä¿': 'ç¯ä¿', 'åŒ–å·¥': 'åŒ–å·¥', 'å»ºæ': 'å»ºæ', 'ç¨€åœŸ': 'ç¨€åœŸ',
            'é”‚ç”µ': 'é”‚ç”µæ± ', 'ç¢³ä¸­å’Œ': 'ç¢³ä¸­å’Œ', 'å…»è€': 'å…»è€', 'çº¢åˆ©': 'çº¢åˆ©',
            'äººå·¥æ™ºèƒ½': 'AI/äººå·¥æ™ºèƒ½', 'æœºå™¨äºº': 'æœºå™¨äºº', 'åˆ¶é€ ': 'å…ˆè¿›åˆ¶é€ ',
            'è£…å¤‡': 'é«˜ç«¯è£…å¤‡', 'æ¸¯è‚¡': 'æ¸¯è‚¡', 'æ’ç”Ÿ': 'æ’ç”Ÿ',
            'æ²ªæ·±300': 'æ²ªæ·±300', 'ä¸­è¯500': 'ä¸­è¯500', 'ä¸­è¯1000': 'ä¸­è¯1000',
            'åˆ›ä¸šæ¿': 'åˆ›ä¸šæ¿', 'ç§‘åˆ›æ¿': 'ç§‘åˆ›æ¿', 'ä¸Šè¯50': 'ä¸Šè¯50',
            'ä¸­å°ç›˜': 'ä¸­å°ç›˜', 'å¤§ç›˜': 'å¤§ç›˜', 'è“ç­¹': 'è“ç­¹', 'æˆé•¿': 'æˆé•¿',
            'ä»·å€¼': 'ä»·å€¼', 'é‡åŒ–': 'é‡åŒ–', 'æŒ‡æ•°': 'æŒ‡æ•°', 'ETF': 'ETF',
            'QDII': 'QDII', 'FOF': 'FOF', 'å€º': 'å€ºåˆ¸', 'æ··åˆ': 'æ··åˆ',
            'è´§å¸': 'è´§å¸', 'è‚¡ç¥¨': 'è‚¡ç¥¨'
        };

        function getSectorsFromName(name) {
            const sectors = [];
            const keys = Object.keys(sectorKeywordMap);
            for (let i = 0; i < keys.length; i++) {
                const keyword = keys[i];
                const sector = sectorKeywordMap[keyword];
                if (name.indexOf(keyword) !== -1 && sectors.indexOf(sector) === -1) {
                    sectors.push(sector);
                }
            }
            return sectors;
        }

        function getSectorTagClass(sector) {
            const stockSectors = ['ç™½é…’','æ¶ˆè´¹','åŒ»è¯','ç§‘æŠ€','åŠå¯¼ä½“','æ–°èƒ½æº','å…‰ä¼','å†›å·¥','é“¶è¡Œ','é‡‘è','åœ°äº§','è¯åˆ¸','é’¢é“','ç…¤ç‚­','æœ‰è‰²é‡‘å±','å†œä¸š','é£Ÿå“é¥®æ–™','æ±½è½¦','ç”µåŠ›','ä¼ åª’','äº’è”ç½‘','è®¡ç®—æœº','é€šä¿¡','ç¯ä¿','åŒ–å·¥','å»ºæ','ç¨€åœŸ','é”‚ç”µæ± ','ç¢³ä¸­å’Œ','AI/äººå·¥æ™ºèƒ½','æœºå™¨äºº','å…ˆè¿›åˆ¶é€ ','é«˜ç«¯è£…å¤‡','çº¢åˆ©'];
            const indexSectors = ['æ²ªæ·±300','ä¸­è¯500','ä¸­è¯1000','åˆ›ä¸šæ¿','ç§‘åˆ›æ¿','ä¸Šè¯50','æŒ‡æ•°','ETF'];
            const bondSectors = ['å€ºåˆ¸','è´§å¸'];
            const marketSectors = ['æ¸¯è‚¡','æ’ç”Ÿ','QDII'];
            if (stockSectors.indexOf(sector) !== -1) return 'cat-stock';
            if (indexSectors.indexOf(sector) !== -1) return 'cat-index';
            if (bondSectors.indexOf(sector) !== -1) return 'cat-bond';
            if (marketSectors.indexOf(sector) !== -1) return 'cat-market';
            return 'cat-theme';
        }

        function renderSectorTags(sectors) {
            if (!sectors || sectors.length === 0) return '';
            return sectors.map(function(s) {
                return '<span class="sector-tag ' + getSectorTagClass(s) + '">' + s + '</span>';
            }).join('');
        }

        function renderFundSectors(code, name) {
            const el = document.getElementById('fundSectors');
            if (!el) return;
            const sectors = getSectorsFromName(name || '');
            fundSectorCache[code] = sectors;
            if (sectors.length > 0) {
                el.innerHTML = '<span style="font-size:13px;color:#888;margin-right:6px;">ğŸ“Œ å…³è”æ¿å—ï¼š</span>' + renderSectorTags(sectors);
            } else {
                el.innerHTML = '<span style="font-size:13px;color:#ccc;">ğŸ“Œ å…³è”æ¿å—ï¼šæš‚æ— åŒ¹é…æ¿å—</span>';
            }
            fetchFundSectorsFromApi(code, function(apiSectors) {
                if (apiSectors && apiSectors.length > 0) {
                    const merged = sectors.slice();
                    apiSectors.forEach(function(s) {
                        if (merged.indexOf(s) === -1) merged.push(s);
                    });
                    fundSectorCache[code] = merged;
                    el.innerHTML = '<span style="font-size:13px;color:#888;margin-right:6px;">ğŸ“Œ å…³è”æ¿å—ï¼š</span>' + renderSectorTags(merged);
                }
            });
        }

        function fetchFundSectorsFromApi(code, callback) {
            const script = document.createElement('script');
            let handled = false;

            script.onload = function() {
                if (handled) return;
                handled = true;
                if (script.parentNode) script.parentNode.removeChild(script);
                try {
                    if (window.apidata && window.apidata.content) {
                        const htmlStr = window.apidata.content;
                        window.apidata = undefined;
                        const parser = new DOMParser();
                        const doc = parser.parseFromString(htmlStr, 'text/html');
                        const rows = doc.querySelectorAll('tbody tr');
                        const industries = [];
                        rows.forEach(function(row) {
                            const tds = row.querySelectorAll('td');
                            if (tds.length >= 2) {
                                const name = (tds[0].textContent || '').trim();
                                const pct = parseFloat((tds[1].textContent || '').replace('%',''));
                                if (name && !isNaN(pct) && pct > 5) {
                                    industries.push(name);
                                }
                            }
                        });
                        callback(industries.slice(0, 5));
                    } else {
                        window.apidata = undefined;
                        callback([]);
                    }
                } catch(e) {
                    callback([]);
                }
            };

            script.onerror = function() {
                if (handled) return;
                handled = true;
                if (script.parentNode) script.parentNode.removeChild(script);
                callback([]);
            };

            script.src = 'https://fundf10.eastmoney.com/FundArchivesDatas.aspx?type=jjhy&code=' + code + '&year=&rt=' + Math.random();
            document.head.appendChild(script);

            setTimeout(function() {
                if (!handled) {
                    handled = true;
                    if (script.parentNode) script.parentNode.removeChild(script);
                    callback([]);
                }
            }, 8000);
        }

        function refreshAllWatchlist() {
            if (watchlist.length === 0) {
                renderWatchlist();
                return;
            }
            let pending = watchlist.length;
            watchlist.forEach(function(item) {
                enqueueJsonp(item.code, function(data) {
                    if (data && data.fundcode) {
                        watchlistData[data.fundcode] = data;
                        item.name = data.name || item.name;
                    }
                    pending--;
                    if (pending <= 0) {
                        saveWatchlist();
                        renderWatchlist();
                        refreshWatchlistRealNav();
                    }
                });
            });
        }

        function refreshWatchlistRealNav() {
            let idx = 0;
            function next() {
                if (idx >= watchlist.length) return;
                const item = watchlist[idx];
                idx++;
                fetchRealNavForWatchlist(item.code, function(records) {
                    if (records.length > 0) {
                        const latest = records[0];
                        watchlistRealNav[item.code] = { change: latest.change, date: latest.date, nav: latest.nav };
                    }
                    updateWatchlistRealNavRow(item.code);
                    setTimeout(next, 200);
                });
            }
            next();
        }

        function updateWatchlistRealNavRow(code) {
            const cell = document.getElementById('wl-real-' + code);
            if (!cell) return;
            const info = watchlistRealNav[code];
            if (info) {
                const changeVal = parseFloat(info.change);
                const cls = changeVal > 0 ? 'up' : changeVal < 0 ? 'down' : 'flat';
                const sign = changeVal > 0 ? '+' : '';
                const text = isNaN(changeVal) ? info.change : `${sign}${changeVal.toFixed(2)}%`;
                const today = new Date();
                const todayStr = today.getFullYear() + '-' + String(today.getMonth()+1).padStart(2,'0') + '-' + String(today.getDate()).padStart(2,'0');
                const isToday = info.date === todayStr;
                const statusTag = isToday
                    ? '<span style="color:#27ae60;font-weight:600;margin-left:4px;font-size:11px;">âœ”å·²æ›´æ–°</span>'
                    : '';
                cell.innerHTML = `<div><span style="font-weight:600;">${info.nav || '--'}</span> <span class="${cls}">${text}</span></div><div style="white-space:nowrap;"><small style="color:#e6a817;font-weight:600;font-size:11px;">${info.date}</small>${statusTag}</div>`;
            } else {
                cell.className = 'flat';
                cell.textContent = '--';
            }
        }

        function renderWatchlist() {
            const container = document.getElementById('watchlistContent');
            if (watchlist.length === 0) {
                container.innerHTML = '<div class="watchlist-empty">æš‚æ— è‡ªé€‰åŸºé‡‘ï¼ŒæŸ¥è¯¢åŸºé‡‘åç‚¹å‡»ã€ŒåŠ å…¥è‡ªé€‰åˆ—è¡¨ã€æ·»åŠ  ~</div>';
                return;
            }

            let rows = watchlist.map(function(item) {
                const data = watchlistData[item.code];
                const rnInfo = watchlistRealNav[item.code];
                let realHtml = '<td id="wl-real-' + item.code + '" class="flat">--</td>';
                if (rnInfo) {
                    const rcVal = parseFloat(rnInfo.change);
                    const rcCls = rcVal > 0 ? 'up' : rcVal < 0 ? 'down' : 'flat';
                    const rcSign = rcVal > 0 ? '+' : '';
                    const rcText = isNaN(rcVal) ? rnInfo.change : `${rcSign}${rcVal.toFixed(2)}%`;
                    const rnNav = rnInfo.nav || '';
                    const rnToday = new Date();
                    const rnTodayStr = rnToday.getFullYear() + '-' + String(rnToday.getMonth()+1).padStart(2,'0') + '-' + String(rnToday.getDate()).padStart(2,'0');
                    const rnIsToday = rnInfo.date === rnTodayStr;
                    const rnStatusTag = rnIsToday
                        ? '<span style="color:#27ae60;font-weight:600;margin-left:4px;font-size:11px;">âœ”å·²æ›´æ–°</span>'
                        : '';
                    realHtml = `<td id="wl-real-${item.code}"><div><span style="font-weight:600;">${rnNav || '--'}</span> <span class="${rcCls}">${rcText}</span></div><div style="white-space:nowrap;"><small style="color:#e6a817;font-weight:600;font-size:11px;">${rnInfo.date}</small>${rnStatusTag}</div></td>`;
                }

                const sectorHtml = (function() {
                    const sectors = fundSectorCache[item.code] || getSectorsFromName(data ? (data.name || item.name) : item.name);
                    if (!fundSectorCache[item.code]) fundSectorCache[item.code] = sectors;
                    return '<td class="watchlist-sector"><div class="sector-tags" style="gap:3px;">' + renderSectorTags(sectors) + '</div></td>';
                })();

                if (!data) {
                    return `<tr>
                        <td><a href="javascript:quickQuery('${item.code}')" style="color:#667eea;text-decoration:none;">${item.code}</a></td>
                        <td>${item.name}</td>
                        ${sectorHtml}
                        <td>--</td>${realHtml}<td>--</td>
                        <td><button class="watchlist-remove-btn" onclick="removeFromWatchlist('${item.code}')">Ã—</button></td>
                    </tr>`;
                }
                const gszzl = parseFloat(data.gszzl);
                const cls = gszzl > 0 ? 'up' : gszzl < 0 ? 'down' : 'flat';
                const sign = gszzl > 0 ? '+' : '';
                const gsz = parseFloat(data.gsz).toFixed(4);
                return `<tr>
                    <td><a href="javascript:quickQuery('${item.code}')" style="color:#667eea;text-decoration:none;">${item.code}</a></td>
                    <td>${data.name || item.name}</td>
                    ${sectorHtml}
                    <td><span style="font-weight:600;">${gsz}</span> <span class="${cls}">${sign}${gszzl.toFixed(2)}%</span></td>
                    ${realHtml}
                    <td style="font-size:12px;color:#999;">${data.gztime || '--'}</td>
                    <td><button class="watchlist-remove-btn" onclick="removeFromWatchlist('${item.code}')">Ã—</button></td>
                </tr>`;
            }).join('');

            container.innerHTML = `
                <div style="overflow-x:auto;">
                    <table class="watchlist-table">
                        <thead>
                            <tr><th>ä»£ç </th><th>åç§°</th><th>å…³è”æ¿å—</th><th>ä¼°å€¼/æ¶¨å¹…</th><th>çœŸå®å‡€å€¼/æ¶¨å¹…</th><th>ä¼°å€¼æ—¶é—´</th><th></th></tr>
                        </thead>
                        <tbody>${rows}</tbody>
                    </table>
                </div>
            `;
        }

        function onWatchlistIntervalChange() {}

        function toggleWatchlistRefresh() {}

        function startWatchlistRefresh() {
            stopWatchlistRefresh();
            refreshAllWatchlist();
            watchlistCountdownTimer = setInterval(function() {
                refreshAllWatchlist();
            }, 30000);
        }

        function stopWatchlistRefresh() {
            if (watchlistCountdownTimer) {
                clearInterval(watchlistCountdownTimer);
                watchlistCountdownTimer = null;
            }
        }

        // Initialize watchlist on load
        (function initWatchlist() {
            renderWatchlist();
            if (watchlist.length > 0) {
                startWatchlistRefresh();
            }
        })();

        // Show history tags on load
        renderHistoryTags();
    </script>
</body>
</html>
